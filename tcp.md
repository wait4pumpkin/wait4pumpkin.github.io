
## ISN

ISN是发送方的数据编号起点（32位）

动态随机生成
+ 增加安全性，为了避免被第三方猜测到，从而被第三方伪造的RST报文。
+ 每个tcp session的字节序列号没有重叠，如果出现tcp五元组冲突这种极小概率情况的发生，一个session的数据也不会被误认为是另一个session的

伪造RST报文，需要满足sequence number位于对方的合法接收窗口内。RST报文选取seq的时候，并不是选取的确定已经发送的seq，而是当前连接已经用掉的seq，哪怕这个报文没有收到回复，也会使用。

## 三次握手

### 为什么是三次

握手的关键事实上是交换双方的ISN，用于确认包的起始、以及哪些包是合法。

发送和确认为两次，双向加起来是四次。其中一次SYN和ACK进行合并，就是三次。

SYN会占一个编号，因此会自动进行超时重传。

### 三次握手的第一次不可以携带数据吗

三次握手还没有完成。如果服务端缓存数据，就会放大SYN FLOOD攻击。

### 第三次可以携带数据吗

能够发出第三次握手报文的主机，肯定接收到第二次（服务器）握手报文（因为伪造IP的主机是不会接收到第二次报文的）。接收到第三次握手的瞬间，服务端的连接状态就会切换至established，可以接收里面携带的数据。

## SYN

SYN标志位会占据sequence的一个序号，因为SYN是建立连接的关键字段，而为了确保对方接收到，使用超时重传机制。TCP规定，只为有数据的TCP报文重传。SYN占据一个序号（可以认为只有一个字节数据的报文），所以TCP会重传SYN报文。

## FIN

### TCP状态位只有FIN+ACK，不会单独出现FIN

RFC793明确规定，除了第一个握手报文SYN除外，其它所有报文必须将ACK=1。其实就是要求接收方要抓住一切的机会，把接收情况告诉发送方。最方便的方式就是，任何我方发送的TCP报文，都要捎带着ACK状态位。

ACK状态位必须与Acknowledge Number配合。如果Acknowledge Number == 10001，那表明序列号10000及之前的字节已经成功接收。

+ 如果对方占据字节序列号10000是应用层数据，那么就是确认应用层数据；
+ 如果对方占据字节序列号10000是FIN状态位，那么就是确认接收到对方的FIN。

## Reference

+ [关于三次握手和四次挥手，面试官想听到怎样的回答？](https://www.zhihu.com/question/271701044/answer/398114686)
+ [TCP 为什么是三次握手，而不是两次或四次？](https://www.zhihu.com/question/24853633/answer/115173386)
