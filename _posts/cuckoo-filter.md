# 布谷鸟过滤器

## 布谷鸟哈希

两个哈希函数`hash1()`和`hash2()`，以`x`为key，桶数量为`n`

```c
p = hash1(x) % n;
q = hash2(x) % n;
```

存储在`p`和`q`中任意空的位置，如果`p`和`q`都被占用，则随意踢走`p`或`q`中元素，腾出空间进行存储。而被踢走的元素重新进行哈希找下一个可用的位置。

如果循环太多次仍没完成所有元素的存储，则进行rehash。

为了提高空间利用率，每个bucket可以扩展为多个slot，用于存储哈希冲突的值。甚至从2个哈希函数扩展到更多个。

## 布谷鸟过滤器

filter和hash table的区别是，hash table存储的是值，filter存储的fingerprint。

还有一个区别是，hash table中两个哈希函数是独立的，filter的两个哈希函数是对偶的。

```c
fp = fingerprint(x)
p = hash(x)
q = p ^ hash(fp)
```

也就是已知fingerprint和其中一个哈希值的情况下，就可以立刻求出另一个哈希值。

这里没有取余是假设了`n`是2的幂，可以直接通过移位获得。理论上布谷鸟过滤器的空间利用率会比bloom filter要高（bloom filter如果越满误判率越高），当然`n`是2的幂会浪费一定空间，不过不是2的幂其实也能跑，CPU会高点。

因为过滤器中存储了fingerprint，所以也可以进行删除操作，这个是相比bloom filter的最大优势。

## 主要缺陷

假设slot的数量是k，当插入同一个元素，或者哈希冲突（为了节省空间，fingerprint位数有限），超过2k时，就会不断rehash，且永远无法成功。

一种解决方案是同一个bucket不允许插入相同的fingerprint，但这样做删除的时候就会有误删的可能，造成不可接受的误判。

如果不改进这个问题，布谷鸟过滤器宣称的支持删除实际上并不使用。一个可能可以解决的方案是，当重复次数超过2k时，考虑加一个counter计数，腾出空间。
