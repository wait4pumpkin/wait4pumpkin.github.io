## 存储结构

大部分使用NAND Flash，衡量寿命使用PE周期（完整擦写的次数）。

SSD内部有多个存储芯片，不同芯片上的多个块组成簇（Clustered Block）。一次数据写入可以同时写入簇中的不同块，提高IO并发。

### Cell

存储的最小单元，存储的位数越多，需要的电位精度就越高，充电更困难（检测失败还要重现充电），因此读写变慢。TLC/MLC都可以模拟SLC。

+ SLC：一个晶体管存储1 bit，速度快，寿命长，售价贵
+ MLC：一个晶体管存储2 bit
+ TLC：一个晶体管存储3 bit，速度慢，寿命短，售价低

### 页

读写SSD的最小单元（2KB/4KB/8KB/16KB），页不能重复写，因此存在写放大的问题。

### 块

由多个页组成（128/256），是数据擦除的基本单元。因为页不能重复写，所以要按块进行擦除才能进行写入（擦除速度慢）。

## 数据更新过程

+ 老数据（页）标记为过期
+ 在空闲页写入新数据
+ 垃圾回收程序检测到块中存在过期数据，把该块中其余有效数据复制到另一个空闲块，然后把块进行擦除

## 原则

+ 按页写入：不满一页会造成空间浪费，如果要继续使用这一页的剩余空间就必须进行块擦除；读取也有读到不需要的数据；

+ 相关数据一起写：写在同一页，读取效率更高；由于内部并行的特性，大量数据一起写，读写速度也会提高；

+ 冷热数据分开写：避免写放大的影响。如果冷热数据在同一页/块，修改热数据或者垃圾回收时，也必须要读冷数据；

+ 缓存热数据：避免频繁的擦除 - 写入；

+ 读写分离：混合的小读写交叉的工作负载会妨碍内部缓存和预读取机制正常工作，并会导致吞吐量下降。最好是一次全部读完然后再写入；

+ 避免长时间大数据写入：如果长时间大数据写入，可能存在垃圾回收速度跟不上写入速度的情况，导致写入请求需要等待垃圾回收进程擦除块；

+ 避免就地（in-place）更新优化：SSD没有寻道时间，且不支持覆盖写，更新数据必须先擦除，再写入，所以就地更新反而会造成性能下降；

+ 对于大的（大于簇的大小）读写操作，单线程比多线程好（内部并行，更好的预读），对于小数据的读写，多线程比单线程好。

## Data Set Management Command

就是SATA常说的Trim，SCSI的UNMAP，NVMe的Deallocate，都是同一个功能。

文件删除时，老的数据还在，只是没有文件指针引用，对于HDD来说没什么问题，但是因为SSD有垃圾回收，这些被删除的数据SSD并不知道是没有用的，依然会不停做搬运。Trim命令就是通知SSD某一段数据已经没有用了，可以丢弃。

该命令包含命令段和数据段两部分。命令段就是Data Set Management 的命令，且option是Trim。数据段则包含了需要把哪个范围的LBA废弃掉的信息：LBA范围 = 起始地址 + 长度。

+ Non-Deterministic Trim
+ Deterministic Trim (DRAT)
+ Deterministic Read Zero after TRIM (RZAT)

Trim有响应时间要求，因此后台做。

如果要支持更小的LBA范围段（小于4K），同时要RZAT，那就只能先读出来清零再写入。要效率高，直接忽略这个指令就好，只要不宣称支持RAAT。

异常掉电恢复过程，读取Trimmed LBA，可能读到老数据，也可能读到0，所谓Non-Deterministic。

NVMe起步要求DRAT，这就要求Trim不能后台做，但如果要求快速响应，只是什么都不做（返回老数据）。

RAID上Trim一般会有问题，因为Trim的时候要更新校验块，所以一般关闭。

## Reference

+ [设计 SSD（固态硬盘）友好的程序](https://www.jianshu.com/p/9eb1eaf30f60)
+ [SSD Trim 详解](http://www.ssdfans.com/blog/2016/07/10/ssd-trim-%E8%AF%A6%E8%A7%A3/)
